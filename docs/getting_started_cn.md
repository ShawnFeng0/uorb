# 添加uORB库到项目中

有两种方式可以在你的项目中使用uORB：

* [使用预构建的uorb二进制库和头文件](#使用uORB的预构建库)。如果你想使用稳定版本的uORB库就使用这个方法。
* [从源代码构建uORB](#从源代码构建uORB)。如果你想调试或者使用最新的修改就使用这个方法。

## 使用uORB的预构建库

建议您在源目录之外构建uORB，以避免CMake生成的文件出现污染源目录的问题：

```shell
mkdir uorb-build
cd uorb-build
cmake -DCMAKE_C_COMPILER=clang     \
        -DCMAKE_CXX_COMPILER=clang++ \
        -DCMAKE_INSTALL_PREFIX=./install \
        $HOME/uorb                         # we're assuming this is where uorb is.
make
make install
```

`./install`目录包含一个lib目录和一个include目录，链接lib目录中的库，然后将include文件夹添加到项目的include路径。

或参考工具链目录（`toolchains`）中的`x.toolchain.cmake`文件，为相应平台编写一个cmake工具链文件。

## 从源代码构建uORB

从源代码构建的最佳方法是将其作为cmake项目的子目录：

将源代码添加到您的项目。

```shell
git submodule add https://github.com/ShawnFeng0/uorb.git # If you don't use git, just download the source code and unzip it.
```

在您自己的项目的CMakeLists.txt中链接uORB库。

```cmake
# uORB library
add_subdirectory(uorb)
target_link_libraries(${PROJECT_NAME} PRIVATE uorb) # Link the uorb library and add the include path of uorb
```

这是使用此方法的一个示例（**推荐**）[uorb-examples](https://github.com/ShawnFeng0/uorb-examples.git).

# 使用uORB

uORB基于话题而不是数据流进行通信，并且每个话题都有对应的结构体。

uORB的C接口在uorb / uorb.h中定义。

## 创建uORB话题

uORB话题由以下宏定义，需要传入话题名称和与该话题对应的结构体参数。

```C++
// uorb/uorb.h
// To declare a topic, usually declare a topic in the header file.
#define ORB_DECLARE(_name, _struct) ...
```

```C++
// uorb/uorb.h
// Define a topic, usually define a topic in the source file, can only be defined once and need to be compiled in the C++ source file (*.cpp/*.cc)
#define ORB_SIMPLE_DEFINE(_name, _struct) ...
```

### 使用工具管理uORB话题

为了以统一的方式管理和修改话题，我们使用消息生成工具，该工具使用类似于ROS的方式来定义话题。

我偷了个懒 ： ）。 我目前不熟悉代码生成工具，所以目前仍使用PX4的代码生成工具（可能会在以后删除），但是用于生成uORB话题的模板文件已被修改。

#### 添加uORB话题

首先，创建一个文件夹来存储uORB话题（原始话题是使用.msg文件定义的，它将生成.h / .cc话题文件）。 然后添加一个话题文件。

```
# msg/example_string.msg

uint64 timestamp # time since system start (microseconds)

uint32 STRING_LENGTH = 128
int8[128] string
```

有关msg文件的格式，请参阅ros和PX4或该项目中的示例。

使用此项目的tools / msg目录中的消息生成工具，可以从* .msg文件生成* .h和* .cc话题源文件。 有许多工具参数。 当前建议参考该项目的示例目录，或者独立的uorb示例项目msg / CMakeLists.txt实现消息生成。

请注意，msg / CMakeLists.txt中的设置生成工具路径的地址必须正确。

```Cmake
# Need to specify the path of generator and message template, they are in the tools/msg directory of this project.
set(tools_root ${CMAKE_CURRENT_SOURCE_DIR}/../../tools/msg)
```

#### 添加uORB话题作为依赖项

将以下语句添加到您创建的msg目录级别的CMakeLists.txt中，以使用话题库作为依赖项。

```cmake
# Generate orb message
add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/msg)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/msg)

# The name of your topic library. It is a library generated after compiling all [topic].cc files. Please refer to the example implementation for details.
link_libraries(uorb_examples_msgs)
```

### 手动管理uORB话题

尽管不建议这样做，但我们也支持直接使用宏手动定义话题，这可能对初学者很有用。 您需要确保在话题头文件中使用`ORB_DECLARE`声明，并在C++源文件中使用`ORB_SIMPLE_DEFINE`定义。

#### 声明uORB话题

只需在话题头文件中包含`uorb/uorb.h`头文件，然后直接声明话题即可。

```C++
// orb_topic.h
#pragma once

#include "uorb/uorb.h"

struct orb_example_struct_str {
  char str[30];
  int32_t index;
};

ORB_DECLARE(example_struct_str, orb_example_struct_str);

struct orb_example_struct_number {
  int16_t num_int16;
  int32_t num_int32;
  int64_t num_int64;
};

ORB_DECLARE(example_struct_number, orb_example_struct_number);
```

#### 定义uORB话题

与声明类似，在包含`uorb/uorb.h`之后在源文件中定义uORB话题。

```C++
// orb_topic.cc
#include "orb_topic.h"

ORB_SIMPLE_DEFINE(example_struct_str, orb_example_struct_str);

ORB_SIMPLE_DEFINE(example_struct_number, orb_example_struct_number);
```

## 发布uORB话题

包含uORB发布头文件：

```C++
#include "uorb/publication.h"
```

包含要发布的话题的头文件：

```c++
// Header file generated by topic generation tool
#include "uorb/topics/example_string.h"

// Or include manually defined topic header files
#include "orb_topic.h"
```

定义要发布的数据类型，使用`uorb::msg::{topic_name}`指定消息名称（*.msg文件名或用`ORB_DECLARE`声明的话题名）：

```c++
uorb::PublicationData<uorb::msg::example_string> pub_example_string;
```

填充数据：

```C++
auto &data = pub_example_string.get();

data.timestamp = orb_absolute_time_us(); // orb_absolute_time_us() from "uorb/abs_time.h"
snprintf((char *)data.string, example_string_s::STRING_LENGTH, "%d: %s", i,
             "This is a string message.");
```
发布数据：

```c++
pub_example_string.Publish();
```

请参考完整的例程：[examples/cpp_pub_sub/cpp_pub_sub.cc](../examples/cpp_pub_sub/cpp_pub_sub.cc) 

## 订阅uORB话题

包含uORB订阅头文件:

```c++
#include "uorb/subscription.h"
```

定义订阅数据类型的变量：

```c++
uorb::SubscriptionDatauorb::msg::example_string sub_example_string;
```

轮询更新：

```c++
if (sub_example_string.Update()) {
  // Data processing...
}
```

或使用`orb_poll()`，该函数类似于`poll()`（推荐此用法）：

```c++
struct orb_pollfd pollfds[] = {
  {.fd = sub_example_string.handle(), .events = POLLIN}};

if (0 < orb_poll(pollfds, ARRAY_SIZE(pollfds), timeout_ms)) {
  if (sub_example_string.Update()) {
    // Data processing...
  }
}
```

获取更新的数据和处理：

```c++
auto data = sub_example_string.get();
printf("timestamp: %" PRIu64 "[us], Receive msg: "%s"\n", data.timestamp,
       data.string);
```

请参考完整的例程：[examples/cpp_pub_sub/cpp_pub_sub.cc](../examples/cpp_pub_sub/cpp_pub_sub.cc)

